import cv2
import numpy as np
import time

#將兩張圖片合併
def stitch_Image(big_img1, img2_to_img1_image):
    img2_to_img1_image = cv2.subtract(img2_to_img1_image, big_img1)
    stitchedImage = cv2.add(big_img1, img2_to_img1_image)
    # cv2.imwrite("stitchedImage.png", stitchedImage)
    return stitchedImage

#顯示對應特徵圖
def show_match(img1, points1, img2, points2, name):
    points1 = np.array(points1)
    points2 = np.array(points2)
    img1_Width = img1.shape[1] #img1的寬度
    image = np.concatenate((img1, img2), axis=1)  #將img1與img2左右合併
    points2[:,0] = [x+img1_Width for x in points2[:,0]] #將points2座標做offset
    
    #將對應點以線跟圓畫出，顏色隨機
    for i in range(len(points1)):
        color = np.random.rand(3,) * 255
        cv2.line(image, (int(points1[i][0]), int(points1[i][1])), (int(points2[i][0]), int(points2[i][1])), color, 1)
        cv2.circle(image,(int(points1[i][0]), int(points1[i][1])), 4, color, 1)
        cv2.circle(image,(int(points2[i][0]), int(points2[i][1])), 4, color, 1)

    cv2.imshow(name, image)
    cv2.imwrite(name+".png", image)
    
#讀入四張圖片
img001 = cv2.imread("001.JPG")
img002 = cv2.imread("002.JPG")
img003 = cv2.imread("003.JPG")
img004 = cv2.imread("004.JPG")

#將特徵對應點都貼到code裡面
match12_img1 = [[8.050470352172852, 515.57470703125], [18.482318878173828, 510.7279968261719], [20.895713806152344, 542.8720092773438], [21.966848373413086, 526.7813110351562], [27.449527740478516, 522.6643676757812], [30.1285400390625, 616.2261962890625], [32.46187973022461, 719.1827392578125], [32.65214157104492, 452.1830139160156], [33.03889083862305, 531.5903930664062], [35.034690856933594, 621.9873657226562], [42.553043365478516, 505.2973327636719], [49.097999572753906, 514.010986328125], [58.801170349121094, 335.28253173828125], [70.87236022949219, 618.2274169921875], [74.3289794921875, 621.1505126953125], [76.103759765625, 520.6460571289062], [76.103759765625, 520.6460571289062], [81.17047882080078, 612.4524536132812], [81.7782211303711, 621.5073852539062], [92.9025650024414, 445.0], [100.64463806152344, 517.595947265625], [102.27019500732422, 511.1542053222656], [102.84581756591797, 523.9458618164062], [103.66365814208984, 545.953857421875], [104.27140808105469, 540.4068603515625], [106.62836456298828, 531.2122802734375], [106.62836456298828, 531.2122802734375], [109.09210968017578, 616.3856811523438], [109.83924102783203, 513.9086303710938], [114.70867919921875, 619.6215209960938], [119.92282104492188, 326.93084716796875], [129.76722717285156, 615.449462890625], [131.61834716796875, 327.89398193359375], [134.46957397460938, 426.14984130859375], [137.63436889648438, 615.1050415039062], [151.6497802734375, 525.9373168945312], [153.4287872314453, 517.1650390625], [153.4287872314453, 517.1650390625], [158.37554931640625, 470.16290283203125], [158.37554931640625, 470.16290283203125], [161.2784881591797, 512.6556396484375], [164.71209716796875, 339.1568298339844], [168.729248046875, 514.2925415039062], [171.88388061523438, 697.3291625976562], [172.9503936767578, 526.5148315429688], [179.78424072265625, 512.09375], [180.25315856933594, 612.6532592773438], [183.93409729003906, 525.80322265625], [184.18356323242188, 522.239013671875], [184.18356323242188, 522.239013671875], [184.41317749023438, 615.0562133789062], [186.04739379882812, 514.1527709960938], [186.72950744628906, 511.40985107421875], [193.84420776367188, 470.8553161621094], [193.84420776367188, 470.8553161621094], [198.51278686523438, 477.8818359375], [198.9858856201172, 508.0501403808594], [203.2403106689453, 511.7470397949219], [203.51634216308594, 522.2008666992188], [203.51634216308594, 522.2008666992188], [205.8750457763672, 611.6694946289062], [206.0345458984375, 344.3425598144531], [208.10581970214844, 616.2075805664062], [211.44285583496094, 604.0831909179688], [213.27349853515625, 159.7212371826172], [217.16824340820312, 511.097412109375], [221.036376953125, 180.3290252685547], [223.068603515625, 615.0009155273438], [224.5191192626953, 498.9156494140625], [226.0390625, 517.1488037109375], [231.32693481445312, 498.3884582519531], [231.32693481445312, 498.3884582519531], [231.32693481445312, 498.3884582519531], [231.32693481445312, 498.3884582519531], [235.57687377929688, 156.7495574951172], [238.515869140625, 521.1533203125], [243.58326721191406, 597.7338256835938], [247.8931121826172, 331.19384765625], [248.15972900390625, 521.8347778320312], [248.15972900390625, 521.8347778320312], [249.50558471679688, 516.2041015625], [253.81765747070312, 522.91552734375], [254.9287872314453, 610.0509643554688], [256.24468994140625, 340.2120361328125], [257.5396423339844, 455.8403015136719], [257.85040283203125, 533.0265502929688], [260.54791259765625, 586.682373046875], [261.0254821777344, 515.293701171875], [261.3199157714844, 609.8364868164062], [262.1717834472656, 594.949951171875], [264.3537902832031, 534.5452880859375], [269.33203125, 598.0880126953125], [269.8564453125, 601.6488647460938], [272.9822692871094, 526.23046875], [273.8977355957031, 552.223876953125], [277.6133117675781, 594.7465209960938], [280.7861328125, 517.6954956054688], [284.06329345703125, 501.828125], [284.1001281738281, 601.7868041992188], [285.1927795410156, 607.1378173828125], [287.9526062011719, 554.3026123046875], [297.650390625, 423.1058349609375], [297.9723205566406, 564.328857421875], [299.7021789550781, 697.3255615234375], [307.6664123535156, 551.13623046875], [307.9747314453125, 526.28759765625], [309.553466796875, 569.067626953125], [309.553466796875, 569.067626953125], [313.3504943847656, 606.5259399414062], [316.03875732421875, 550.2877807617188], [316.21044921875, 608.494384765625], [317.9043884277344, 592.564208984375], [318.50848388671875, 517.9424438476562], [320.8979187011719, 509.921142578125], [322.93194580078125, 512.9913330078125], [324.40228271484375, 556.5640869140625], [324.40228271484375, 556.5640869140625], [327.9112548828125, 514.134765625], [329.4165344238281, 502.8102111816406], [332.6581726074219, 570.0674438476562], [335.1980895996094, 503.54345703125], [337.34234619140625, 566.8746337890625], [338.961669921875, 508.8315734863281], [346.8398132324219, 94.62523651123047], [348.072509765625, 143.90647888183594], [349.0226745605469, 345.3602294921875], [355.1491394042969, 539.2675170898438], [369.35211181640625, 452.4876403808594], [369.7969055175781, 202.26348876953125], [371.1070556640625, 453.30950927734375], [371.6124572753906, 510.0509338378906], [372.16900634765625, 238.88514709472656], [381.80120849609375, 351.29534912109375], [383.1273498535156, 219.0837860107422], [383.1273498535156, 219.0837860107422], [383.5746765136719, 524.7167358398438], [383.5746765136719, 524.7167358398438], [389.17523193359375, 466.68157958984375], [389.2803039550781, 519.202392578125], [389.2803039550781, 519.202392578125], [389.7097473144531, 522.5763549804688], [392.53076171875, 460.99884033203125], [399.72174072265625, 521.72802734375], [399.72174072265625, 521.72802734375], [403.98468017578125, 445.48846435546875], [410.41864013671875, 520.5653076171875], [414.67803955078125, 456.0946350097656], [415.08843994140625, 529.63623046875], [415.9944763183594, 497.23931884765625], [420.5087890625, 517.2279052734375], [420.5087890625, 517.2279052734375], [421.60369873046875, 415.1585693359375], [421.8085021972656, 512.2933349609375], [422.3472595214844, 423.2330322265625], [425.7935791015625, 515.2798461914062], [427.8183288574219, 446.9980163574219], [427.8199157714844, 525.8169555664062], [428.76177978515625, 506.3811340332031], [432.33099365234375, 509.6308898925781], [439.9193115234375, 460.76177978515625], [449.2906188964844, 521.0433349609375], [451.7939453125, 447.1968994140625], [456.4610900878906, 441.3988952636719], [465.17828369140625, 546.033447265625], [468.1471252441406, 547.1466674804688], [469.8609619140625, 542.5160522460938], [469.8609619140625, 542.5160522460938], [474.0633239746094, 549.4457397460938], [476.090087890625, 514.983154296875], [479.9760437011719, 471.52508544921875], [481.8783264160156, 446.752197265625], [481.9772644042969, 495.4845886230469], [485.58746337890625, 547.0360107421875], [487.0011291503906, 513.431396484375], [487.0011291503906, 513.431396484375], [487.4296569824219, 510.4635925292969], [493.4050598144531, 549.6934204101562], [493.7930908203125, 505.8069152832031], [497.31646728515625, 542.5054931640625], [498.82525634765625, 512.39306640625], [510.6647033691406, 513.1893920898438], [510.6647033691406, 513.1893920898438], [513.6243286132812, 442.4599914550781], [517.880126953125, 509.6522216796875]]
match12_img2 = [[228.56947326660156, 510.5550842285156], [238.57081604003906, 506.0856628417969], [239.95608520507812, 537.0719604492188], [241.434326171875, 521.6555786132812], [246.76234436035156, 517.8486938476562], [246.54763793945312, 607.9893798828125], [245.7721710205078, 707.3339233398438], [253.23007202148438, 449.9962158203125], [251.72828674316406, 526.61376953125], [251.02291870117188, 613.8094482421875], [261.5506896972656, 501.2680358886719], [267.3341979980469, 509.96588134765625], [280.2288818359375, 337.0820617675781], [285.152099609375, 611.5877685546875], [288.3121032714844, 614.4879150390625], [292.8625793457031, 517.1256103515625], [292.8625793457031, 517.1256103515625], [295.1213684082031, 606.4253540039062], [295.34832763671875, 615.2017822265625], [310.8055725097656, 444.0606384277344], [316.52020263671875, 514.7030639648438], [318.3012390136719, 508.43328857421875], [318.3573913574219, 521.0125732421875], [318.74505615234375, 542.156982421875], [319.4283142089844, 537.0416259765625], [321.90728759765625, 528.2176513671875], [321.90728759765625, 528.2176513671875], [322.0079345703125, 611.2584228515625], [325.43792724609375, 511.4142761230469], [326.3917236328125, 614.5122680664062], [339.0215759277344, 328.94305419921875], [341.77459716796875, 611.1891479492188], [350.6611633300781, 330.0799560546875], [350.5174865722656, 426.18804931640625], [349.5649108886719, 611.1663208007812], [365.361572265625, 524.3576049804688], [367.4600830078125, 515.6207275390625], [367.4600830078125, 515.6207275390625], [373.22760009765625, 469.6723327636719], [373.22760009765625, 469.6723327636719], [375.2330627441406, 511.5728454589844], [382.0519104003906, 341.171630859375], [382.3768005371094, 513.2783813476562], [379.87890625, 693.5769653320312], [386.1774597167969, 525.4443359375], [393.1773986816406, 511.39599609375], [390.99603271484375, 610.4788818359375], [396.92327880859375, 525.0385131835938], [397.3344421386719, 521.5866088867188], [397.3344421386719, 521.5866088867188], [394.8958435058594, 613.0552978515625], [398.9837341308594, 513.6050415039062], [400.1733703613281, 510.8863525390625], [408.0083312988281, 470.9394226074219], [408.0083312988281, 470.9394226074219], [412.3086242675781, 478.0452575683594], [412.03912353515625, 507.8784484863281], [416.2923889160156, 511.6844482421875], [416.215087890625, 521.7503662109375], [416.215087890625, 521.7503662109375], [416.2240905761719, 610.5198364257812], [422.2439880371094, 346.2693176269531], [417.6705322265625, 615.0787353515625], [422.1708068847656, 603.0875854492188], [431.2369384765625, 163.11001586914062], [429.94036865234375, 511.4347839355469], [438.9211730957031, 183.376708984375], [432.9654846191406, 614.4187622070312], [437.62548828125, 499.5894470214844], [438.51605224609375, 517.5615844726562], [444.23956298828125, 498.99176025390625], [444.23956298828125, 498.99176025390625], [444.23956298828125, 498.99176025390625], [444.23956298828125, 498.99176025390625], [453.4804992675781, 159.6953125], [450.71405029296875, 521.9105834960938], [453.74871826171875, 598.15576171875], [464.12591552734375, 333.1084289550781], [460.27386474609375, 522.8469848632812], [460.27386474609375, 522.8469848632812], [461.8547058105469, 517.2430419921875], [465.8918762207031, 524.1411743164062], [464.6300354003906, 611.0032348632812], [472.26019287109375, 342.16143798828125], [471.0768127441406, 457.2963562011719], [469.69256591796875, 534.3312377929688], [470.95654296875, 588.058349609375], [473.1477355957031, 516.7382202148438], [470.9639892578125, 610.9136962890625], [472.06585693359375, 596.0221557617188], [475.9374694824219, 536.0590209960938], [479.3003234863281, 599.5563354492188], [479.5782470703125, 603.1729125976562], [484.9687194824219, 528.0134887695312], [484.997802734375, 553.8262939453125], [487.6836853027344, 596.5968017578125], [492.8556213378906, 519.6846313476562], [496.8408508300781, 503.86480712890625], [493.98199462890625, 603.8629760742188], [495.0778503417969, 609.2210693359375], [499.0762634277344, 556.3849487304688], [512.0355834960938, 425.1234436035156], [508.7366943359375, 566.5192260742188], [506.6496276855469, 700.3473510742188], [518.9412841796875, 554.0391845703125], [520.026611328125, 528.9722900390625], [519.9342041015625, 571.87255859375], [519.9342041015625, 571.87255859375], [523.2631225585938, 609.7930297851562], [527.5919799804688, 553.3624877929688], [526.0602416992188, 612.0712280273438], [528.350341796875, 595.9412841796875], [530.8445434570312, 520.9852294921875], [533.5541381835938, 512.9444580078125], [535.7369384765625, 516.0864868164062], [535.9519653320312, 560.01171875], [535.9519653320312, 560.01171875], [540.6312255859375, 517.313720703125], [542.5492553710938, 505.9189147949219], [543.83544921875, 573.9012451171875], [548.1838989257812, 506.8359680175781], [548.8616333007812, 570.8436889648438], [552.1248168945312, 512.2943725585938], [564.8563232421875, 94.52229309082031], [565.5902709960938, 143.9576416015625], [565.9525756835938, 347.1835632324219], [568.3628540039062, 543.7457275390625], [584.2359008789062, 455.876708984375], [589.877685546875, 202.2235107421875], [586.1634521484375, 456.668701171875], [585.5391235351562, 514.4141845703125], [592.2578125, 238.6355743408203], [599.3369140625, 353.1923522949219], [603.163818359375, 218.04383850097656], [603.163818359375, 218.04383850097656], [597.410888671875, 529.60595703125], [597.410888671875, 529.60595703125], [604.5965576171875, 470.6947021484375], [603.485107421875, 524.1427001953125], [603.485107421875, 524.1427001953125], [603.8848876953125, 527.6371459960938], [608.23779296875, 464.89678955078125], [614.1106567382812, 527.0125732421875], [614.1106567382812, 527.0125732421875], [620.558837890625, 449.3009033203125], [625.2174072265625, 526.1609497070312], [631.2518310546875, 460.2699890136719], [629.9561157226562, 535.5393676757812], [631.5394287109375, 502.5020446777344], [635.8328247070312, 522.9886474609375], [635.8328247070312, 522.9886474609375], [640.1422729492188, 418.68536376953125], [637.4495239257812, 518.1889038085938], [639.76611328125, 426.8114013671875], [641.3156127929688, 521.3012084960938], [645.0846557617188, 451.1864318847656], [642.9234008789062, 531.9476318359375], [644.817626953125, 512.1229248046875], [648.4223022460938, 515.490966796875], [658.1094360351562, 465.70721435546875], [665.7781982421875, 527.8045654296875], [670.9172973632812, 451.9242248535156], [674.9898071289062, 445.9515380859375], [681.8425903320312, 553.9706420898438], [684.93896484375, 555.1945190429688], [686.7686157226562, 550.4901123046875], [686.7686157226562, 550.4901123046875], [691.0718994140625, 558.0090942382812], [694.1505126953125, 522.2402954101562], [698.9220581054688, 477.46099853515625], [701.3143310546875, 451.95648193359375], [700.7385864257812, 502.3448181152344], [703.603515625, 555.9335327148438], [705.7162475585938, 520.9822998046875], [705.7162475585938, 520.9822998046875], [706.483154296875, 517.9824829101562], [711.6525268554688, 558.670654296875], [713.1099853515625, 513.2960205078125], [715.4561157226562, 551.5618896484375], [718.29150390625, 519.9910888671875], [730.8670043945312, 521.400634765625], [730.8670043945312, 521.400634765625], [736.0924072265625, 448.0103759765625], [738.5592651367188, 517.9284057617188]]

match23_img2 = [[13.136762619018555, 618.3807373046875], [39.85361862182617, 444.6651306152344], [45.18925094604492, 609.0873413085938], [59.812652587890625, 529.538818359375], [63.15873336791992, 456.931884765625], [66.45258331298828, 519.4254150390625], [74.48335266113281, 514.4651489257812], [83.57132720947266, 502.3548583984375], [85.60751342773438, 535.3280639648438], [89.52857971191406, 511.0839538574219], [89.52857971191406, 511.0839538574219], [90.9972152709961, 516.9547729492188], [92.80679321289062, 610.8198852539062], [93.74223327636719, 520.6093139648438], [101.0604248046875, 525.9321899414062], [106.52079772949219, 515.5396728515625], [106.82915496826172, 532.6263427734375], [107.4880142211914, 511.9283142089844], [107.51620483398438, 459.1607971191406], [108.04845428466797, 500.6075744628906], [116.50037384033203, 535.10009765625], [119.83728790283203, 606.41748046875], [126.67007446289062, 494.55975341796875], [136.35108947753906, 540.8660888671875], [140.05946350097656, 219.02561950683594], [141.97183227539062, 494.0541687011719], [142.0853729248047, 609.9904174804688], [149.35125732421875, 501.9384765625], [158.8082733154297, 610.5693359375], [159.92800903320312, 491.0045166015625], [165.91102600097656, 485.1669921875], [181.29730224609375, 468.6141357421875], [182.0799102783203, 607.6271362304688], [186.91148376464844, 522.3267211914062], [193.14312744140625, 523.9434814453125], [197.99671936035156, 534.6592407226562], [205.63543701171875, 509.41900634765625], [209.7977752685547, 510.5075988769531], [217.5528564453125, 611.9278564453125], [228.56947326660156, 510.5550842285156], [232.91644287109375, 517.6503295898438], [235.1725311279297, 507.37628173828125], [238.57081604003906, 506.0856628417969], [239.95608520507812, 537.0719604492188], [240.46543884277344, 518.0592651367188], [241.434326171875, 521.6555786132812], [243.21356201171875, 510.9219970703125], [245.7721710205078, 707.3339233398438], [245.7721710205078, 707.3339233398438], [246.54763793945312, 607.9893798828125], [246.76234436035156, 517.8486938476562], [249.74041748046875, 711.2766723632812], [251.72828674316406, 526.61376953125], [251.72828674316406, 526.61376953125], [253.23007202148438, 449.9962158203125], [261.26434326171875, 505.8116149902344], [264.48748779296875, 694.9332275390625], [267.3341979980469, 509.96588134765625], [267.3341979980469, 509.96588134765625], [272.6698303222656, 509.3637390136719], [283.16729736328125, 543.3297119140625], [284.45123291015625, 512.8234252929688], [284.45123291015625, 512.8234252929688], [285.152099609375, 611.5877685546875], [288.3121032714844, 614.4879150390625], [291.76739501953125, 510.95977783203125], [291.8789978027344, 449.48291015625], [292.8625793457031, 517.1256103515625], [292.8625793457031, 517.1256103515625], [295.1213684082031, 606.4253540039062], [295.34832763671875, 615.2017822265625], [298.626220703125, 513.9215087890625], [301.558837890625, 520.0505981445312], [302.71136474609375, 525.431640625], [305.6574401855469, 706.0126342773438], [310.05670166015625, 525.011962890625], [312.51678466796875, 706.36767578125], [316.52020263671875, 514.7030639648438], [316.52020263671875, 514.7030639648438], [318.3012390136719, 508.43328857421875], [318.74505615234375, 542.156982421875], [321.90728759765625, 528.2176513671875], [321.90728759765625, 528.2176513671875], [322.0079345703125, 611.2584228515625], [326.3917236328125, 614.5122680664062], [326.3917236328125, 614.5122680664062], [331.84619140625, 444.63726806640625], [332.85284423828125, 332.4505920410156], [333.7763366699219, 613.9056396484375], [342.1845397949219, 716.6109008789062], [342.1845397949219, 716.6109008789062], [365.361572265625, 524.3576049804688], [386.1774597167969, 525.4443359375], [390.99603271484375, 610.4788818359375], [393.1773986816406, 511.39599609375], [395.3758239746094, 481.01275634765625], [396.486572265625, 530.3272705078125], [396.92327880859375, 525.0385131835938], [397.3344421386719, 521.5866088867188], [397.3344421386719, 521.5866088867188], [412.03912353515625, 507.8784484863281], [416.215087890625, 521.7503662109375], [416.215087890625, 521.7503662109375], [422.1708068847656, 603.0875854492188], [426.2635498046875, 486.78643798828125], [431.4336853027344, 502.1961669921875]]
match23_img3 = [[308.0914611816406, 615.0109252929688], [339.90789794921875, 449.0577392578125], [338.9898681640625, 607.6464233398438], [356.0870666503906, 531.7083740234375], [361.51580810546875, 461.26434326171875], [362.6388854980469, 521.9341430664062], [370.1518249511719, 517.3756103515625], [379.589599609375, 505.8771057128906], [380.17169189453125, 538.0396728515625], [384.79815673828125, 514.6127319335938], [384.79815673828125, 514.6127319335938], [386.08905029296875, 520.4148559570312], [384.218505859375, 611.8090209960938], [388.5467834472656, 524.0945434570312], [395.2983703613281, 529.5477294921875], [401.1006164550781, 519.5886840820312], [400.8026123046875, 536.1199340820312], [401.9202880859375, 515.9617309570312], [403.8902893066406, 464.5852966308594], [402.98687744140625, 504.9820251464844], [410.109375, 539.0930786132812], [410.39892578125, 608.8818969726562], [421.03570556640625, 499.7731018066406], [428.9823913574219, 545.5278930664062], [441.25396728515625, 229.28445434570312], [436.24658203125, 499.6835021972656], [431.8208312988281, 613.6651611328125], [442.9585876464844, 507.94305419921875], [448.1582946777344, 615.1746826171875], [453.7337646484375, 497.3592529296875], [460.0225830078125, 491.54254150390625], [475.3692932128906, 475.9441833496094], [471.1053466796875, 613.6734008789062], [479.1324462890625, 529.2777709960938], [485.16094970703125, 531.1470947265625], [489.3985290527344, 541.9024658203125], [497.960693359375, 517.1763916015625], [502.1658630371094, 518.4201049804688], [506.21685791015625, 619.8582763671875], [520.9349365234375, 519.046875], [525.0737915039062, 526.38623046875], [527.4884033203125, 516.2687377929688], [531.0465698242188, 515.0606079101562], [531.2547607421875, 546.2122192382812], [532.529052734375, 527.1445922851562], [533.3582153320312, 530.7666015625], [535.8441772460938, 520.0269775390625], [530.0149536132812, 717.232666015625], [530.0149536132812, 717.232666015625], [535.1729736328125, 617.6439819335938], [538.8757934570312, 527.185546875], [533.5947265625, 721.5518798828125], [543.5875854492188, 536.1531372070312], [543.5875854492188, 536.1531372070312], [547.7589111328125, 459.3439025878906], [553.9032592773438, 515.7031860351562], [549.5216064453125, 706.3811645507812], [559.967041015625, 520.0180053710938], [559.967041015625, 520.0180053710938], [565.49609375, 519.5186767578125], [574.6448364257812, 554.152587890625], [577.2977905273438, 523.6624755859375], [577.2977905273438, 523.6624755859375], [574.2225341796875, 623.5038452148438], [577.3729248046875, 626.6211547851562], [584.91845703125, 521.8757934570312], [587.3513793945312, 459.6956481933594], [585.9923095703125, 528.165283203125], [585.9923095703125, 528.165283203125], [584.5921020507812, 618.7654418945312], [584.4529418945312, 627.740966796875], [591.4912109375, 525.1160278320312], [594.43017578125, 531.459716796875], [595.2113037109375, 537.1256713867188], [591.0279541015625, 720.4287719726562], [603.062744140625, 536.9708862304688], [597.81591796875, 721.3251953125], [610.1648559570312, 526.7508544921875], [610.1648559570312, 526.7508544921875], [612.3102416992188, 520.3531494140625], [611.4220581054688, 554.8754272460938], [615.3860473632812, 540.69482421875], [615.3860473632812, 540.69482421875], [611.9761352539062, 625.353271484375], [616.7175903320312, 628.9573974609375], [616.7175903320312, 628.9573974609375], [628.46240234375, 455.68084716796875], [632.7247924804688, 341.3567810058594], [624.2510986328125, 628.728271484375], [627.880615234375, 733.9755249023438], [627.880615234375, 733.9755249023438], [660.6668701171875, 538.5151977539062], [682.554443359375, 540.4732666015625], [684.2105712890625, 628.52685546875], [690.502197265625, 526.2646484375], [693.769287109375, 494.9687194824219], [693.0831909179688, 545.986083984375], [693.874267578125, 540.5856323242188], [694.6240844726562, 536.949462890625], [694.6240844726562, 536.949462890625], [710.7009887695312, 523.3609619140625], [714.588623046875, 538.1422729492188], [714.588623046875, 538.1422729492188], [717.1240234375, 622.8130493164062], [726.1533813476562, 501.8045349121094], [731.4374389648438, 517.9913330078125]]

match34_img3 = [[54.640010833740234, 230.91195678710938], [56.464778900146484, 419.31378173828125], [62.81623077392578, 518.5574340820312], [63.058006286621094, 419.1142272949219], [70.49394226074219, 512.9677124023438], [77.07603454589844, 505.80938720703125], [82.03033447265625, 472.5225524902344], [82.70227813720703, 607.6922607421875], [87.6138916015625, 256.8777160644531], [87.6138916015625, 256.8777160644531], [87.98228454589844, 528.6233520507812], [90.35438537597656, 536.8038330078125], [90.83149719238281, 462.3573303222656], [104.3768310546875, 214.2564697265625], [106.55267333984375, 240.94801330566406], [107.9482192993164, 624.5189819335938], [108.92443084716797, 600.0450439453125], [115.21495056152344, 644.4537963867188], [118.81254577636719, 616.6908569335938], [124.31614685058594, 293.19207763671875], [126.04463195800781, 610.7727661132812], [128.5257110595703, 446.954345703125], [132.79872131347656, 557.3164672851562], [135.5073699951172, 219.14366149902344], [140.76966857910156, 540.6229248046875], [143.93287658691406, 446.57965087890625], [145.93345642089844, 521.912109375], [153.95462036132812, 523.82421875], [159.08963012695312, 420.2653503417969], [164.85194396972656, 248.2176055908203], [165.53762817382812, 593.039794921875], [165.99517822265625, 598.3760986328125], [165.99517822265625, 598.3760986328125], [169.67507934570312, 500.3124694824219], [172.48736572265625, 470.639892578125], [172.85086059570312, 455.06005859375], [173.86643981933594, 506.08270263671875], [173.86643981933594, 506.08270263671875], [177.05223083496094, 605.3775024414062], [177.68724060058594, 313.3158264160156], [180.62257385253906, 502.84228515625], [184.1409912109375, 317.6895751953125], [185.1016082763672, 308.76019287109375], [185.1016082763672, 308.76019287109375], [186.5149688720703, 240.10940551757812], [187.87176513671875, 453.162109375], [188.00904846191406, 338.7484130859375], [197.38772583007812, 500.24383544921875], [197.38772583007812, 500.24383544921875], [200.13467407226562, 343.1505126953125], [203.02841186523438, 491.2986145019531], [210.64028930664062, 209.08653259277344], [221.5447235107422, 510.6449279785156], [221.94805908203125, 500.0137939453125], [222.04991149902344, 493.8469543457031], [226.96945190429688, 498.9278564453125], [229.70077514648438, 610.748779296875], [229.8478546142578, 510.0738830566406], [229.85769653320312, 503.1289367675781], [231.3975067138672, 484.5587463378906], [231.73728942871094, 475.3944091796875], [231.73728942871094, 475.3944091796875], [233.5587615966797, 521.8760986328125], [235.18470764160156, 504.48919677734375], [241.50523376464844, 520.487060546875], [241.50523376464844, 520.487060546875], [243.89013671875, 507.9464111328125], [244.8064727783203, 335.8095703125], [249.02288818359375, 490.84466552734375], [249.64599609375, 521.3633422851562], [249.64599609375, 521.3633422851562], [250.53314208984375, 505.21160888671875], [259.88690185546875, 505.1393737792969], [264.2533264160156, 460.6288146972656], [266.4442138671875, 523.0750732421875], [266.4442138671875, 523.0750732421875], [269.2629089355469, 515.623291015625], [269.2629089355469, 515.623291015625], [270.1203308105469, 519.3619995117188], [270.47711181640625, 530.8338623046875], [275.1305847167969, 524.7265625], [276.7547607421875, 553.1699829101562], [277.73681640625, 339.9912109375], [278.936279296875, 486.1700744628906], [285.82415771484375, 444.2009582519531], [287.5751647949219, 514.5184936523438], [287.5751647949219, 514.5184936523438], [287.5751647949219, 514.5184936523438], [287.7257995605469, 350.1709899902344], [287.9216003417969, 490.9830627441406], [295.9409484863281, 535.00634765625], [296.40771484375, 519.4828491210938], [296.8216247558594, 529.6849975585938], [297.3069763183594, 517.2392578125], [311.0952453613281, 441.7928771972656], [318.9925537109375, 614.8590698242188], [324.01300048828125, 509.09423828125], [330.4441223144531, 606.0068359375], [331.5694885253906, 435.4788818359375], [336.7694396972656, 451.6767883300781], [338.9898681640625, 607.6464233398438], [339.66290283203125, 514.7606811523438], [339.90789794921875, 449.0577392578125], [342.2303771972656, 427.7781066894531], [349.506591796875, 505.8665771484375], [350.6258850097656, 497.674072265625], [356.0870666503906, 531.7083740234375], [356.2482604980469, 428.64666748046875], [357.3084411621094, 512.5169677734375], [361.78887939453125, 583.0248413085938], [362.6388854980469, 521.9341430664062], [370.1518249511719, 517.3756103515625], [373.45709228515625, 533.4752807617188], [374.2928466796875, 548.5760498046875], [379.589599609375, 505.8771057128906], [384.79815673828125, 514.6127319335938], [384.79815673828125, 514.6127319335938], [385.38775634765625, 432.3877868652344], [388.5467834472656, 524.0945434570312], [401.1006164550781, 519.5886840820312], [401.9202880859375, 515.9617309570312], [403.8902893066406, 464.5852966308594], [406.3442687988281, 509.8771057128906], [406.7124328613281, 462.35992431640625], [407.1273498535156, 429.06011962890625], [407.4220275878906, 513.7549438476562], [410.109375, 539.0930786132812], [421.03570556640625, 499.7731018066406], [423.2492980957031, 516.8560180664062], [428.9823913574219, 545.5278930664062], [434.8744812011719, 617.1226196289062], [442.9585876464844, 507.94305419921875]]
match34_img4 = [[354.6711120605469, 255.89352416992188], [352.8204345703125, 437.77789306640625], [356.1287536621094, 533.8617553710938], [358.8408508300781, 437.6792297363281], [363.4974365234375, 528.7882080078125], [370.0174255371094, 521.9345703125], [375.7399597167969, 489.8853759765625], [372.1411437988281, 621.0661010742188], [385.7236633300781, 280.256591796875], [385.7236633300781, 280.256591796875], [379.7727966308594, 544.4856567382812], [381.80474853515625, 552.5180053710938], [384.52447509765625, 480.1303405761719], [402.13934326171875, 238.28919982910156], [404.0447998046875, 264.140380859375], [395.5761413574219, 638.8140869140625], [397.4085693359375, 615.1922607421875], [402.2107849121094, 659.041015625], [406.44696044921875, 631.5661010742188], [421.7764892578125, 315.44305419921875], [413.45416259765625, 626.2672729492188], [420.9161682128906, 465.84503173828125], [422.42547607421875, 574.0704345703125], [433.04742431640625, 242.64865112304688], [430.4383544921875, 557.9019775390625], [436.2467346191406, 465.7938232421875], [436.0679016113281, 539.9862670898438], [443.6169738769531, 541.9254150390625], [451.7207336425781, 440.28094482421875], [460.6723327636719, 270.7875671386719], [452.7630310058594, 610.6925659179688], [453.11639404296875, 615.9503173828125], [453.11639404296875, 615.9503173828125], [459.67022705078125, 519.31591796875], [463.4383850097656, 490.0669250488281], [464.434814453125, 474.4721374511719], [463.483154296875, 525.0908813476562], [463.483154296875, 525.0908813476562], [463.5252380371094, 623.4258422851562], [472.6479797363281, 334.4573059082031], [470.3673095703125, 522.077880859375], [479.55584716796875, 338.8268737792969], [480.0538330078125, 330.00042724609375], [480.0538330078125, 330.00042724609375], [481.9788818359375, 262.49371337890625], [478.9899597167969, 472.9953918457031], [482.08148193359375, 359.6964111328125], [486.9980163574219, 520.0744018554688], [486.9980163574219, 520.0744018554688], [493.6612548828125, 364.2375793457031], [492.79669189453125, 511.2933349609375], [506.51318359375, 230.9859161376953], [510.50482177734375, 531.1025390625], [511.4339599609375, 520.554931640625], [511.5960693359375, 514.3259887695312], [516.2109985351562, 519.782470703125], [516.1387329101562, 631.478271484375], [518.8600463867188, 530.8676147460938], [519.158447265625, 523.9163208007812], [521.3690795898438, 505.3896179199219], [521.7915649414062, 496.2808532714844], [521.7915649414062, 496.2808532714844], [522.355712890625, 542.8658447265625], [524.43603515625, 525.2876586914062], [530.3834228515625, 541.6626586914062], [530.3834228515625, 541.6626586914062], [533.1431274414062, 529.1665649414062], [538.6259765625, 356.78411865234375], [538.31396484375, 512.1480102539062], [538.553955078125, 542.8838500976562], [538.553955078125, 542.8838500976562], [539.976806640625, 526.5891723632812], [549.3047485351562, 526.8370361328125], [554.90625, 482.1362609863281], [555.492919921875, 545.1343383789062], [555.492919921875, 545.1343383789062], [558.9269409179688, 537.636474609375], [558.9269409179688, 537.636474609375], [559.3118286132812, 541.505126953125], [559.353515625, 553.0930786132812], [564.115234375, 547.0161743164062], [564.9348754882812, 575.821533203125], [572.2128295898438, 361.0969543457031], [569.2081298828125, 508.3228759765625], [577.37353515625, 466.1332092285156], [577.341796875, 537.2703247070312], [577.341796875, 537.2703247070312], [577.341796875, 537.2703247070312], [581.7625122070312, 371.14410400390625], [578.403564453125, 513.4424438476562], [585.3416137695312, 558.283447265625], [586.0765380859375, 542.5089111328125], [586.17724609375, 552.9275512695312], [587.0151977539062, 540.3287353515625], [603.3067626953125, 464.14422607421875], [606.1470947265625, 640.4312133789062], [614.7913818359375, 532.8760986328125], [618.0745849609375, 632.0978393554688], [624.2732543945312, 458.0791015625], [629.6821899414062, 474.7445983886719], [627.1583251953125, 634.10107421875], [630.943115234375, 539.3381958007812], [633.1008911132812, 472.1183776855469], [635.4850463867188, 450.4421691894531], [641.6238403320312, 530.491455078125], [642.68896484375, 522.0009155273438], [647.44775390625, 557.1876220703125], [650.3140869140625, 451.60589599609375], [649.2730712890625, 537.57861328125], [651.8259887695312, 610.026611328125], [654.3935546875, 547.4777221679688], [663.029541015625, 543.1235961914062], [665.4993286132812, 559.7360229492188], [665.1232299804688, 575.309326171875], [672.6651000976562, 531.5203247070312], [678.0843505859375, 540.6691284179688], [678.0843505859375, 540.6691284179688], [680.3961791992188, 455.821533203125], [681.8089599609375, 550.5459594726562], [695.1292724609375, 546.36865234375], [696.002197265625, 542.5096435546875], [699.6044311523438, 489.60931396484375], [701.0513305664062, 536.5502319335938], [702.7159423828125, 487.3618469238281], [704.25537109375, 452.9775390625], [701.7760009765625, 540.5841674804688], [704.0177001953125, 567.0400390625], [717.0194091796875, 526.59521484375], [718.844482421875, 544.4197387695312], [723.9293212890625, 574.4071044921875], [727.9872436523438, 649.0460815429688], [740.0926513671875, 535.7969970703125]]

#畫出特徵對應點圖
show_match(img001, match12_img1, img002, match12_img2, "match12")
show_match(img002, match23_img2, img003, match23_img3, "match23")
show_match(img003, match34_img3, img004, match34_img4, "match34")

border = 1000 #設定圖片向外擴增多少

#將所有圖片都向外擴增border成大圖片
img001 = cv2.copyMakeBorder(img001, border, border, border, border, cv2.BORDER_CONSTANT, 0)
img002 = cv2.copyMakeBorder(img002, border, border, border, border, cv2.BORDER_CONSTANT, 0)
img003 = cv2.copyMakeBorder(img003, border, border, border, border, cv2.BORDER_CONSTANT, 0)
img004 = cv2.copyMakeBorder(img004, border, border, border, border, cv2.BORDER_CONSTANT, 0)

#將所有特徵對應點的座標都offset (border,border)
match12_img1 = np.add(np.array(match12_img1), border)
match12_img2 = np.add(np.array(match12_img2), border)
match23_img2 = np.add(np.array(match23_img2), border)
match23_img3 = np.add(np.array(match23_img3), border)
match34_img3 = np.add(np.array(match34_img3), border)
match34_img4 = np.add(np.array(match34_img4), border)

#求出圖片一到圖片二的homography，再將圖片一轉換過去與圖片二合併
img1_to_img2_h,status = cv2.findHomography(match12_img1 , match12_img2, cv2.RANSAC,5.0)

img2_Height, img2_Width, img2_Channel = img001.shape
img1_to_img2_image = cv2.warpPerspective(img001,img1_to_img2_h,(img2_Width, img2_Height))
# cv2.imshow("img1_to_img2_image.png", img1_to_img2_image)

img1_2 = stitch_Image(img002, img1_to_img2_image)


#求出圖片三到圖片二的homography，再將圖片三轉換過去與圖片二合併
img3_to_img2_h,status = cv2.findHomography(match23_img3 , match23_img2, cv2.RANSAC,5.0)

img2_Height, img2_Width, img2_Channel = img003.shape
img3_to_img2_image = cv2.warpPerspective(img003,img3_to_img2_h,(img2_Width, img2_Height))
# cv2.imshow("img3_to_img2_image.png", img3_to_img2_image)

img1_2_3 = stitch_Image(img1_2, img3_to_img2_image)


#求出圖片四到圖片三的homography，因為圖片三已經被轉過所以圖片四要轉到圖片二要再多乘上三到二的homography，再將圖片四轉換過去與圖片二合併
img4_to_img3_h,status = cv2.findHomography(match34_img4 , match34_img3, cv2.RANSAC,5.0)
img4_to_img2_h = img4_to_img3_h.dot(img3_to_img2_h)

img2_Height, img2_Width, img2_Channel = img004.shape
img4_to_img2_image = cv2.warpPerspective(img004,img4_to_img2_h,(img2_Width, img2_Height))
# cv2.imshow("img4_to_img2_image.png", img4_to_img2_image)

img1_2_3_4 = stitch_Image(img1_2_3, img4_to_img2_image)


#最後將一整個大圖片縮小到合併的圖片範圍
x, y, z = (img1_2_3_4 > 0).nonzero()
stitch_image = np.copy(img1_2_3_4[min(x):max(x), min(y):max(y), :])
cv2.imshow("stitch_image.png", stitch_image)
cv2.imwrite("stitch_image.png", stitch_image)

cv2.waitKey(0)
cv2.destroyAllWindows()